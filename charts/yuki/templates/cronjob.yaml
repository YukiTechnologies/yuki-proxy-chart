{{- $endpoints := list 
  (dict "name" "system" "redisKey" "yuki-system-monitoring") 
  (dict "name" "compute" "redisKey" "yuki-compute-monitoring") 
}}
{{- range $endpoint := $endpoints }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $endpoint.name }}-monitoring-job
spec:
  schedule: "*/1 * * * *"
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 30
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          initContainers:
            - name: curl-{{ $endpoint.name }}
              image: alpine/curl:8.14.1
              imagePullPolicy: IfNotPresent
              command: [ "/bin/sh" ]
              args:
                - "-c"
                - |
                  echo "Starting health check for {{ $endpoint.name }} endpoint: $TARGET_URL"
                  if curl -f --max-time 30 --retry 3 --retry-delay 1 "$TARGET_URL"; then
                    echo "✅ Health check PASSED for {{ $endpoint.name }}"
                    echo 'true' > /data/result.txt
                  else
                    echo "❌ Health check FAILED for {{ $endpoint.name }}"
                    echo 'false' > /data/result.txt
                  fi
                  echo "Health check result written to /data/result.txt"
              env:
                - name: TARGET_URL
                  {{- if eq $endpoint.name "system" }}
                  value: "{{ $.Values.app.container.env.SYSTEM_HOST }}/health"
                  {{- else if eq $endpoint.name "compute" }}
                  value: "{{ $.Values.app.container.env.COMPUTE_HOST }}/compute/health"
                  {{- end }}
              volumeMounts:
                - name: data-dir
                  mountPath: "/data"
          containers:
            - name: set-{{ $endpoint.name }}-result
              image: redis:8.2.1-alpine
              imagePullPolicy: IfNotPresent
              command: [ "/bin/sh" ]
              args:
                - "-c"
                - |
                  echo "Reading health check result for {{ $endpoint.name }}..."
                  RESULT=$(cat /data/result.txt)
                  echo "Result: $RESULT"
                  echo "Setting Redis key '$REDIS_KEY' to '$RESULT' with 120s expiry..."
                  REDIS_CMD="redis-cli -c -h $REDIS_HOST -p ${REDIS_PORT:-6379}"
                  [ "$REDIS_TLS" = "true" ] && REDIS_CMD="$REDIS_CMD --tls"
                  [ -n "$REDIS_PASSWORD" ] && export REDISCLI_AUTH="$REDIS_PASSWORD"
                  if $REDIS_CMD set $REDIS_KEY $RESULT EX 120; then
                    echo "✅ Successfully updated Redis key '$REDIS_KEY' for {{ $endpoint.name }}"
                  else
                    echo "❌ Failed to update Redis key '$REDIS_KEY' for {{ $endpoint.name }}"
                    exit 1
                  fi
              volumeMounts:
                - name: data-dir
                  mountPath: /data
              env:
                - name: REDIS_KEY
                  value: {{ $endpoint.redisKey | quote }}
                {{- range $key, $value := $.Values.app.container.env }}
                - name: {{ $key }}
                  value: {{ $value | quote }}
                {{- end }}
                {{- if and $.Values.redis $.Values.redis.password }}
                - name: REDIS_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ $.Values.redis.password.secretName }}
                      key: {{ $.Values.redis.password.secretKey }}
                {{- end }}
                {{- if and $.Values.redis $.Values.redis.tls }}
                - name: REDIS_TLS
                  value: {{ $.Values.redis.tls | quote }}
                {{- end }}
          {{- with $.Values.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $.Values.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          restartPolicy: OnFailure
          volumes:
            - name: data-dir
              emptyDir: { }
{{- end }}
