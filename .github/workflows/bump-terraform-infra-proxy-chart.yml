name: Bump terraform-infra proxy chart version

on:
  push:
    tags:
      - "proxy-*"

jobs:
  bump-terraform-infra:
    runs-on: ubuntu-latest

    steps:
      - name: Check out yuki-proxy-chart (this repo)
        uses: actions/checkout@v4

      - name: Extract proxy chart version from tag
        id: version
        run: |
          TAG="${GITHUB_REF##*/}"        # e.g. proxy-0.0.58
          VER="${TAG#proxy-}"            # 0.0.58
          echo "version=$VER" >> "$GITHUB_OUTPUT"

      - name: Check out terraform-infra
        uses: actions/checkout@v4
        with:
          repository: YukiTechnologies/terraform-infra
          token: ${{ secrets.TERRAFORM_INFRA_TOKEN }}
          path: terraform-infra

      - name: Update proxyChartVersion in production base values
        working-directory: terraform-infra
        run: |
          FILE="apps/charts/genesis/values/production/base.yaml"
          sed -i.bak "s/^proxyChartVersion: .*/proxyChartVersion: ${{ steps.version.outputs.version }}/" "$FILE"
          rm "$FILE.bak"
          echo "Updated $FILE to proxyChartVersion: ${{ steps.version.outputs.version }}"

      - name: Commit and push change to terraform-infra main
        working-directory: terraform-infra
        env:
          GITHUB_TOKEN: ${{ secrets.TERRAFORM_INFRA_TOKEN }}
        run: |
          git config user.name "proxy-chart-bot"
          git config user.email "proxy-chart-bot@yuki.local"

          # Ensure we are on latest main
          git checkout main
          git pull origin main

          git add apps/charts/genesis/values/production/base.yaml
          git commit -m "Bump yuki-proxy chart to ${{ steps.version.outputs.version }}" \
                      -m "Co-Authored-By: Warp <agent@warp.dev>" || echo "No changes to commit"

          # Only push if there is a new commit
          if [ -n "$(git log origin/main..HEAD)" ]; then
            git push origin HEAD:main
          else
            echo "No new commits to push to main"
          fi
